version: '3.8'

services:
  glyphforge:
    build: .
    container_name: glyphforge-app
    ports:
      - "3001:3001"
      - "40001:3001"
    volumes:
      # Modify to your actual NAS path
      # Synology example: /volume1/docker/glyphforge-data:/datas
      # QNAP example: /share/Container/glyphforge-data:/datas
      # TrueNAS example: /mnt/tank/docker/glyphforge-data:/datas
      - /var/services/homes/dannyho/deployment_datas/Glyphforge:/datas
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # 資源限制（NAS kernel 4.4.302+ 不支援 CPU CFS scheduler，Docker 24.0.2 起會報錯，暫時停用）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M
    # 健康檢查（可選）
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3001/api/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
